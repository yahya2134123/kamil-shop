<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kamil Shop Firebase</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
import { getFirestore, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";

// Replace with your Firebase config
const firebaseConfig = {
    apiKey: "AIzaSyBveM-Qj3iLz8sMQhB5QDiStAtHwB1_ZLU",
    authDomain: "kamil-shop-3fd8b.firebaseapp.com",
    projectId: "kamil-shop-3fd8b",
    storageBucket: "kamil-shop-3fd8b.appspot.com",
    messagingSenderId: "806502993381",
    appId: "1:806502993381:web:77c3a5cad63fb699c2330c",
    measurementId: "G-7419GNWM9E"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// Elements
const loginForm = document.getElementById('loginForm');
const emailInput = document.getElementById('email');
const passInput = document.getElementById('password');
const registerBtn = document.getElementById('registerBtn');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');

const uploadForm = document.getElementById('uploadForm');
const imgInput = document.getElementById('imgInput');
const imgPreview = document.getElementById('imgPreview');
const nameInput = document.getElementById('nameInput');
const descInput = document.getElementById('descInput');
const priceInput = document.getElementById('priceInput');
const galleryDiv = document.getElementById('gallery');
const sideBtn = document.getElementById('sideBtn');

let formVisible = false;

// Toggle form
sideBtn.addEventListener('click', ()=>{
    formVisible = !formVisible;
    if(formVisible){
        uploadForm.style.display='block';
        uploadForm.classList.add('fade-in');
        sideBtn.textContent='-';
    } else {
        uploadForm.classList.add('fade-out');
        setTimeout(()=>{ uploadForm.style.display='none'; uploadForm.classList.remove('fade-out'); },400);
        sideBtn.textContent='+';
    }
});

// Image preview
imgInput.addEventListener('change', ()=>{
    const file = imgInput.files[0];
    if(file && file.type.startsWith('image/')){
        const reader = new FileReader();
        reader.onload = e => { imgPreview.src = e.target.result; imgPreview.style.display='block'; };
        reader.readAsDataURL(file);
    } else { imgPreview.style.display='none'; imgPreview.src=''; }
});

// Register/Login
registerBtn.addEventListener('click', async ()=>{
    const email = emailInput.value;
    const password = passInput.value;
    if(!email||!password){ alert('Fill all'); return; }
    try{ await createUserWithEmailAndPassword(auth,email,password); alert('Account created!'); }
    catch(e){ alert(e.message); }
});

loginBtn.addEventListener('click', async ()=>{
    const email = emailInput.value;
    const password = passInput.value;
    if(!email||!password){ alert('Fill all'); return; }
    try{ await signInWithEmailAndPassword(auth,email,password); alert('Logged in!'); }
    catch(e){ alert(e.message); }
});

logoutBtn.addEventListener('click', async ()=>{ await signOut(auth); });

onAuthStateChanged(auth,user=>{
    if(user){
        logoutBtn.style.display='inline-block';
        loginForm.style.display='none';
        loadGallery(user.uid);
    }else{
        logoutBtn.style.display='none';
        loginForm.style.display='block';
        galleryDiv.innerHTML='';
    }
});

// Load gallery for user
async function loadGallery(uid){
    galleryDiv.innerHTML='';
    const q = query(collection(db,'products'), where('owner','==',uid));
    const snapshot = await getDocs(q);
    snapshot.forEach(doc=>{
        const data = doc.data();
        const card = document.createElement('div');
        card.className='card';
        card.innerHTML=`
            <img src="${data.imgUrl}" alt="Product">
            <div class="info">
                <h3>${data.name}</h3>
                <p>${data.desc}</p>
                <p class="price">${data.price} DH</p>
            </div>
            <div class="chat-icon" onclick="alert('Chat demo')">ðŸ’¬</div>
        `;
        galleryDiv.appendChild(card);
    });
}

// Upload product
document.getElementById('uploadBtn').addEventListener('click', async ()=>{
    const user = auth.currentUser;
    if(!user){ alert('Login first'); return; }
    if(!imgInput.files[0] || !nameInput.value || !descInput.value || !priceInput.value){ alert('Fill all'); return; }

    const file = imgInput.files[0];
    if(!file.type.startsWith('image/')){ alert('Choose image only'); return; }

    const storageRef = ref(storage, 'products/' + Date.now() + '-' + file.name);
    await uploadBytes(storageRef, file);
    const imgUrl = await getDownloadURL(storageRef);

    await addDoc(collection(db,'products'),{
        owner: user.uid,
        name: nameInput.value,
        desc: descInput.value,
        price: priceInput.value,
        imgUrl
    });

    loadGallery(user.uid);

    // Reset & hide form with fade-out
    imgInput.value=''; imgPreview.src=''; imgPreview.style.display='none';
    nameInput.value=''; descInput.value=''; priceInput.value='';
    uploadForm.classList.add('fade-out');
    setTimeout(()=>{ uploadForm.style.display='none'; uploadForm.classList.remove('fade-out'); },400);
    sideBtn.textContent='+';
    formVisible=false;
});
</script>

<style>
body{font-family:Arial;text-align:center;background:#fff;margin:0;padding:0}
.card{width:220px;margin:10px;display:inline-block;vertical-align:top;text-align:left;border-radius:8px;overflow:hidden;box-shadow:0 3px 10px rgba(0,0,0,.15)}
.card img{width:100%;height:150px;object-fit:cover}
.card .info{padding:8px}
.card h3{margin:4px 0;font-size:16px}
.card p{margin:2px 0;font-size:13px;color:#555}
.price{font-weight:bold;color:#111}
.chat-icon{position:absolute;top:10px;right:10px;background:#007bff;color:#fff;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer}
#uploadForm{display:none;padding:20px;border:1px solid #ddd;width:400px;margin:20px auto;text-align:left;position:relative;opacity:1;transition:opacity .4s}
#uploadForm.fade-out{opacity:0}
#uploadForm.fade-in{opacity:1}
#sideBtn{position:fixed;top:20px;left:20px;padding:10px 14px;background:rgba(0,0,0,.25);color:#fff;border:0;border-radius:6px;cursor:pointer;font-weight:bold}
#imgPreview{display:none;width:100%;height:150px;object-fit:cover;margin:10px 0;border-radius:6px;box-shadow:0 2px 5px rgba(0,0,0,.2);}
</style>
</head>
<body>

<h1>Kamil Shop Firebase</h1>

<div id="loginForm">
    <input type="email" id="email" placeholder="Email"><br>
    <input type="password" id="password" placeholder="Password"><br>
    <button id="registerBtn">Register</button>
    <button id="loginBtn">Login</button>
    <button id="logoutBtn" style="display:none">Logout</button>
</div>

<button id="sideBtn">+</button>

<div id="uploadForm">
    <h2>Upload Product</h2>
    <input type="file" id="imgInput" accept="image/*">
    <img id="imgPreview" alt="Preview">
    <input type="text" id="nameInput" placeholder="Smiya dyal produit">
    <textarea id="descInput" placeholder="Lwasf dyal produit"></textarea>
    <input type="text" id="priceInput" placeholder="Taman (DH)">
    <button id="uploadBtn">Upload</button>
</div>

<div id="gallery"></div>

</body>
</html>
